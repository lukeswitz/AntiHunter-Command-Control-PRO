generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  role         Role
  legalAcceptedAt DateTime?
  firstName    String?
  lastName     String?
  phone        String?
  jobTitle     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  commandLogs  CommandLog[]
  auditLogs    AuditLog[]
  preferences  UserPreference?
  permissions  UserPermission[]
  siteAccess   UserSiteAccess[]
  invitationsSent UserInvitation[] @relation("UserInvitations")
  passwordResetTokens PasswordResetToken[]
}

enum Role {
  ADMIN
  OPERATOR
  ANALYST
  VIEWER
}

model AppConfig {
  id                   Int      @id @default(1)
  appName              String   @default("Command Center")
  timezone             String?
  env                  String   @default("DEV")

  protocol             String   @default("meshtastic-like")
  ackTimeoutMs         Int      @default(3000)
  resultTimeoutMs      Int      @default(10000)
  maxRetries           Int      @default(2)
  perNodeCmdRate       Int      @default(8)
  globalCmdRate        Int      @default(30)

  detectMode           Int      @default(2)
  detectChannels       String   @default("1..14")
  detectScanSecs       Int      @default(300)
  allowForever         Boolean  @default(false)
  baselineSecs         Int      @default(300)
  deviceScanSecs       Int      @default(300)
  droneSecs            Int      @default(600)
  deauthSecs           Int      @default(300)
  randomizeSecs        Int      @default(600)

  defaultRadiusM       Int      @default(200)

  logLevel             String   @default("info")
  structuredLogs       Boolean  @default(true)

  nodePosRetentionDays Int      @default(30)
  commandRetentionDays Int      @default(180)
  auditRetentionDays   Int      @default(365)

  metricsEnabled       Boolean  @default(true)
  metricsPath          String   @default("/metrics")
  healthEnabled        Boolean  @default(true)

  mapTileUrl           String   @default("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  mapAttribution       String   @default("OpenStreetMap contributors")
  minZoom              Int      @default(2)
  maxZoom              Int      @default(18)

  alertColorIdle       String   @default("#38BDF8")
  alertColorInfo       String   @default("#2563EB")
  alertColorNotice     String   @default("#22C55E")
  alertColorAlert      String   @default("#F97316")
  alertColorCritical   String   @default("#EF4444")

  mailEnabled         Boolean  @default(false)
  mailHost            String?
  mailPort            Int?     @default(587)
  mailSecure          Boolean  @default(false)
  mailUser            String?
  mailPassword        String?
  mailFrom            String   @default("Command Center <no-reply@command-center.local>")
  mailPreview         Boolean  @default(true)
  securityAppUrl      String   @default("http://localhost:5173")
  invitationExpiryHours Int   @default(48)
  passwordResetExpiryHours Int @default(4)

  allowApi             Boolean  @default(true)
  updatedAt            DateTime @updatedAt
}

model Node {
  id          String          @id
  siteId      String?
  originSiteId String?
  name        String?
  lastMessage String?
  lastSeen    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  site        Site?           @relation(fields: [siteId], references: [id])
  positions   NodePosition[]
  triangulations TriangulationResult[]

  @@index([siteId])
  @@index([originSiteId])
}

model NodePosition {
  id        String   @id @default(cuid())
  nodeId    String
  lat       Float
  lon       Float
  ts        DateTime @default(now())

  node      Node     @relation(fields: [nodeId], references: [id])

  @@index([nodeId, ts])
}

model Target {
  id        String   @id @default(cuid())
  siteId    String?
  name      String?
  mac       String?
  deviceType String?
  firstNodeId String?
  lat       Float
  lon       Float
  url       String?
  notes     String?
  tags      String[] @default([])
  status    TargetStatus @default(ACTIVE)
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site      Site?    @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
}

model InventoryDevice {
  mac                 String   @id
  siteId              String?
  vendor              String?
  type                String?
  ssid                String?
  hits                Int      @default(0)
  lastSeen            DateTime?
  maxRSSI             Int?
  minRSSI             Int?
  avgRSSI             Float?
  locallyAdministered Boolean  @default(false)
  multicast           Boolean  @default(false)
  lastNodeId          String?
  lastLat             Float?
  lastLon             Float?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  site                Site?    @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([lastSeen])
  @@index([lastNodeId])
}

model CommandTemplate {
  id         String   @id @default(cuid())
  siteId     String?
  name       String
  template   String
  parameters Json?
  createdBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  site       Site?    @relation(fields: [siteId], references: [id])
}

model CommandLog {
  id              String        @id @default(cuid())
  siteId          String?
  userId          String?
  target          String
  name            String
  params          Json?
  status          CommandStatus @default(PENDING)
  startedAt       DateTime      @default(now())
  createdAt       DateTime      @default(now())
  finishedAt      DateTime?
  ackKind         String?
  ackStatus       String?
  ackNode         String?
  resultText      String?
  errorText       String?
  idempotencyKey  String?       @unique

  site            Site?         @relation(fields: [siteId], references: [id])
  user            User?         @relation(fields: [userId], references: [id])

  @@index([siteId])
  @@index([status])
  @@index([createdAt])
  @@index([target])
}

enum CommandStatus {
  PENDING
  SENT
  OK
  ERROR
}

model AuditLog {
  id        String   @id @default(cuid())
  siteId    String?
  userId    String?
  action    String
  entity    String?
  entityId  String?
  before    Json?
  after     Json?
  createdAt DateTime @default(now())

  site      Site?    @relation(fields: [siteId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([siteId, createdAt])
}

model OuiCache {
  oui       String   @id
  vendor    String
  updatedAt DateTime @updatedAt
}

model TriangulationResult {
  id        String   @id @default(cuid())
  nodeId    String
  targetRef String
  lines     String
  createdAt DateTime @default(now())

  node      Node     @relation(fields: [nodeId], references: [id])

  @@index([targetRef])
  @@index([nodeId, createdAt])
}

model AlarmConfig {
  id             Int     @id @default(1)
  audioPack      String  @default("default")
  volumeInfo     Int     @default(60)
  volumeNotice   Int     @default(70)
  volumeAlert    Int     @default(80)
  volumeCritical Int     @default(90)
  gapInfoMs      Int     @default(1000)
  gapNoticeMs    Int     @default(1500)
  gapAlertMs     Int     @default(2000)
  gapCriticalMs  Int     @default(0)
  dndStart       String?
  dndEnd         String?
  backgroundAllowed Boolean @default(false)
  updatedAt      DateTime @updatedAt
}

model AlarmSound {
  level     String  @id
  filename  String
  updatedAt DateTime @updatedAt
}

model VisualConfig {
  id               Int     @id @default(1)
  pulseHzAlert     Float   @default(1.0)
  pulseHzCritical  Float   @default(2.0)
  blinkMs          Int     @default(400)
  strokeBasePx     Int     @default(2)
  strokeCriticalPx Int     @default(4)
  theme            String  @default("auto")
  updatedAt        DateTime @updatedAt
}

model CoverageConfig {
  id             Int     @id @default(1)
  defaultRadiusM Int     @default(200)
  dynamicEnabled Boolean @default(false)
  dynamicModel   String?
  updatedAt      DateTime @updatedAt
}

model NodeCoverageOverride {
  nodeId       String @id
  radiusMeters Int
  updatedAt    DateTime @updatedAt
}

model Site {
  id        String   @id
  name      String
  color     String   @default("#2E7D32")
  region    String?
  geojson   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serial    SerialConfig?
  mqtt      MqttConfig?
  nodes     Node[]
  targets   Target[]
  devices   InventoryDevice[]
  commandLogs CommandLog[]
  audits    AuditLog[]
  templates CommandTemplate[]
  userAccess UserSiteAccess[]
}

model SerialConfig {
  siteId              String @id
  devicePath          String?
  baud                Int?
  dataBits            Int?
  parity              String?
  stopBits            Int?
  delimiter           String?
  reconnectBaseMs     Int?
  reconnectMaxMs      Int?
  reconnectJitter     Float?
  reconnectMaxAttempts Int?
  enabled             Boolean @default(true)
  updatedAt           DateTime @updatedAt

  site                Site   @relation(fields: [siteId], references: [id])
}

model MqttConfig {
  id          Int     @id @default(autoincrement())
  brokerUrl   String
  clientId    String
  username    String?
  password    String?
  tlsEnabled  Boolean @default(true)
  caPem       String?
  certPem     String?
  keyPem      String?
  qosEvents   Int     @default(1)
  qosCommands Int     @default(1)
  enabled     Boolean @default(false)
  siteId      String
  updatedAt   DateTime @updatedAt

  site        Site    @relation(fields: [siteId], references: [id])

  @@unique([siteId])
}

model UserPreference {
  userId         String @id
  theme          String @default("auto")
  density        String @default("compact")
  mapState       Json?
  tablePrefs     Json?
  terminalFilters Json?
  muteLevels     Json?
  language       String @default("en")
  notifications  Json?
  timeFormat     String @default("24h")
  updatedAt      DateTime @updatedAt

  user           User   @relation(fields: [userId], references: [id])
}

enum TargetStatus {
  ACTIVE
  TRIANGULATING
  RESOLVED
}

enum TakProtocol {
  UDP
  TCP
  HTTPS
}

model TakConfig {
  id            Int          @id @default(1)
  enabled       Boolean      @default(false)
  protocol      TakProtocol  @default(UDP)
  host          String?
  port          Int?
  tlsEnabled    Boolean      @default(false)
  cafile        String?
  certfile      String?
  keyfile       String?
  username      String?
  password      String?
  apiKey        String?
  streamNodes          Boolean @default(true)
  streamTargets        Boolean @default(true)
  streamCommandAcks    Boolean @default(false)
  streamCommandResults Boolean @default(false)
  streamAlertInfo      Boolean @default(false)
  streamAlertNotice    Boolean @default(true)
  streamAlertAlert     Boolean @default(true)
  streamAlertCritical  Boolean @default(true)
  lastConnected DateTime?
  updatedAt     DateTime     @updatedAt
}

model UserPermission {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  granted   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, feature])
}

enum SiteAccessLevel {
  VIEW
  MANAGE
}

model UserSiteAccess {
  id        String          @id @default(cuid())
  userId    String
  siteId    String
  level     SiteAccessLevel @default(VIEW)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id])
  site Site @relation(fields: [siteId], references: [id])

  @@unique([userId, siteId])
}

model UserInvitation {
  id         String   @id @default(cuid())
  email      String
  role       Role
  token      String   @unique
  expiresAt  DateTime
  siteIds    String[]
  permissions String[] @default([])
  message    String?
  inviterId  String?
  acceptedAt DateTime?
  createdAt  DateTime @default(now())

  inviter User? @relation("UserInvitations", fields: [inviterId], references: [id])
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  consumedAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
