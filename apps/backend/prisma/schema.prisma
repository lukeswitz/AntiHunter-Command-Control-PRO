generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  passwordHash           String
  role                   Role
  legalAcceptedAt        DateTime?
  firstName              String?
  lastName               String?
  phone                  String?
  jobTitle               String?
  isActive               Boolean   @default(true)
  twoFactorEnabled       Boolean   @default(false)
  twoFactorSecret        String?
  twoFactorTempSecret    String?
  twoFactorRecoveryCodes String[]  @default([])
  twoFactorEnabledAt     DateTime?
  failedLoginAttempts    Int       @default(0)
  lastFailedLoginAt      DateTime?
  lockedAt               DateTime?
  lockedUntil            DateTime?
  lockedBy               String?
  lockedReason           String?
  lastLoginAt            DateTime?
  lastLoginIp            String?
  lastLoginCountry       String?
  lastLoginUserAgent     String?
  anomalyFlag            Boolean   @default(false)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  commandLogs         CommandLog[]
  auditLogs           AuditLog[]
  preferences         UserPreference?
  permissions         UserPermission[]
  siteAccess          UserSiteAccess[]
  invitationsSent     UserInvitation[]     @relation("UserInvitations")
  passwordResetTokens PasswordResetToken[]
  alertRules          AlertRule[]
  webhooks            Webhook[]
}

enum Role {
  ADMIN
  OPERATOR
  ANALYST
  VIEWER
}

enum AlertRuleScope {
  PERSONAL
  GLOBAL
}

enum AlertRuleMatchMode {
  ANY
  ALL
}

enum AlarmLevel {
  INFO
  NOTICE
  ALERT
  CRITICAL
}

enum WebhookEventType {
  ALERT_TRIGGERED
  INVENTORY_UPDATED
  NODE_TELEMETRY
  TARGET_DETECTED
  NODE_ALERT
  DRONE_TELEMETRY
  COMMAND_ACK
  COMMAND_RESULT
  SERIAL_RAW
}

enum FirewallPolicy {
  ALLOW
  DENY
}

enum FirewallGeoMode {
  DISABLED
  ALLOW_LIST
  BLOCK_LIST
}

enum FirewallRuleType {
  ALLOW
  BLOCK
  TEMP_BLOCK
}

enum FirewallLogOutcome {
  ALLOWED
  BLOCKED
  GEO_BLOCK
  DEFAULT_DENY
  AUTH_FAILURE
  AUTH_SUCCESS
}

enum DroneStatus {
  UNKNOWN
  FRIENDLY
  NEUTRAL
  HOSTILE
}

model AppConfig {
  id       Int     @id @default(1)
  appName  String  @default("Command Center")
  timezone String?
  env      String  @default("DEV")

  protocol        String @default("meshtastic-rewrite")
  ackTimeoutMs    Int    @default(3000)
  resultTimeoutMs Int    @default(10000)
  maxRetries      Int    @default(2)
  perNodeCmdRate  Int    @default(8)
  globalCmdRate   Int    @default(30)

  detectMode     Int     @default(2)
  detectChannels String  @default("1..14")
  detectScanSecs Int     @default(300)
  allowForever   Boolean @default(false)
  baselineSecs   Int     @default(300)
  deviceScanSecs Int     @default(300)
  droneSecs      Int     @default(600)
  deauthSecs     Int     @default(300)
  randomizeSecs  Int     @default(600)

  defaultRadiusM Int @default(50)

  logLevel       String  @default("info")
  structuredLogs Boolean @default(true)

  nodePosRetentionDays Int @default(30)
  commandRetentionDays Int @default(180)
  auditRetentionDays   Int @default(365)

  metricsEnabled Boolean @default(true)
  metricsPath    String  @default("/metrics")
  healthEnabled  Boolean @default(true)

  mapTileUrl     String @default("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  mapAttribution String @default("OpenStreetMap contributors")
  minZoom        Int    @default(2)
  maxZoom        Int    @default(18)

  themeLightBackground String @default("#f3f4f6")
  themeLightSurface    String @default("#ffffff")
  themeLightText       String @default("#1F2933")
  themeDarkBackground  String @default("#0F172A")
  themeDarkSurface     String @default("#111C32")
  themeDarkText        String @default("#E2E8F0")
  themeAccentPrimary   String @default("#2563EB")

  alertColorIdle     String @default("#38BDF8")
  alertColorInfo     String @default("#2563EB")
  alertColorNotice   String @default("#22C55E")
  alertColorAlert    String @default("#F97316")
  alertColorCritical String @default("#EF4444")

  mailEnabled              Boolean @default(false)
  mailHost                 String?
  mailPort                 Int?    @default(587)
  mailSecure               Boolean @default(false)
  mailUser                 String?
  mailPassword             String?
  mailFrom                 String  @default("Command Center <no-reply@command-center.local>")
  mailPreview              Boolean @default(true)
  securityAppUrl           String  @default("http://localhost:5173")
  invitationExpiryHours    Int     @default(48)
  passwordResetExpiryHours Int     @default(4)

  allowApi  Boolean  @default(true)
  updatedAt DateTime @updatedAt
}

model Node {
  id                   String    @id
  siteId               String?
  originSiteId         String?
  name                 String?
  lastMessage          String?
  lastSeen             DateTime?
  temperatureC         Float?
  temperatureF         Float?
  temperatureUpdatedAt DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  site           Site?                 @relation(fields: [siteId], references: [id])
  positions      NodePosition[]
  triangulations TriangulationResult[]
  drones         Drone[]

  @@index([siteId])
  @@index([originSiteId])
}

model Drone {
  id          String   @id
  droneId     String?
  mac         String?
  nodeId      String?
  siteId      String?
  originSiteId String?
  lat         Float
  lon         Float
  altitude    Float?
  speed       Float?
  operatorLat Float?
  operatorLon Float?
  rssi        Int?
  status      DroneStatus @default(UNKNOWN)
  lastSeen    DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  node Node? @relation(fields: [nodeId], references: [id])
  site Site? @relation(fields: [siteId], references: [id])
  originSite Site? @relation("DroneOriginSite", fields: [originSiteId], references: [id])

  @@index([siteId])
  @@index([nodeId])
  @@index([droneId])
  @@index([originSiteId])
}

model NodePosition {
  id     String   @id @default(cuid())
  nodeId String
  lat    Float
  lon    Float
  ts     DateTime @default(now())

  node Node @relation(fields: [nodeId], references: [id])

  @@index([nodeId, ts])
}

model Target {
  id                     String       @id @default(cuid())
  siteId                 String?
  name                   String?
  mac                    String?
  deviceType             String?
  firstNodeId            String?
  lat                    Float
  lon                    Float
  url                    String?
  notes                  String?
  tags                   String[]     @default([])
  status                 TargetStatus @default(ACTIVE)
  createdBy              String?
  trackingConfidence     Float?
  trackingUncertainty    Float?
  triangulationMethod    String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  site Site? @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
}

model InventoryDevice {
  mac                 String    @id
  siteId              String?
  vendor              String?
  type                String?
  ssid                String?
  channel             Int?
  hits                Int       @default(0)
  lastSeen            DateTime?
  maxRSSI             Int?
  minRSSI             Int?
  avgRSSI             Float?
  locallyAdministered Boolean   @default(false)
  multicast           Boolean   @default(false)
  lastNodeId          String?
  lastLat             Float?
  lastLon             Float?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  site Site? @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([lastSeen])
  @@index([lastNodeId])
}

model AlertRule {
  id              String             @id @default(cuid())
  name            String
  description     String?
  scope           AlertRuleScope     @default(PERSONAL)
  ownerId         String?
  severity        AlarmLevel         @default(ALERT)
  matchMode       AlertRuleMatchMode @default(ANY)
  isActive        Boolean            @default(true)
  ouiPrefixes     String[]           @default([])
  ssids           String[]           @default([])
  channels        Int[]              @default([])
  macAddresses    String[]           @default([])
  inventoryMacs   String[]           @default([])
  minRssi         Int?
  maxRssi         Int?
  notifyVisual    Boolean            @default(true)
  notifyAudible   Boolean            @default(true)
  notifyEmail     Boolean            @default(false)
  emailRecipients String[]           @default([])
  messageTemplate String?
  mapStyle        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  lastTriggeredAt DateTime?

  owner      User?              @relation(fields: [ownerId], references: [id])
  events     AlertEvent[]
  webhooks   AlertRuleWebhook[]
  deliveries WebhookDelivery[]

  @@index([ownerId])
  @@index([scope])
  @@index([isActive])
  @@index([lastTriggeredAt])
}

model AlertEvent {
  id          String    @id @default(cuid())
  ruleId      String
  nodeId      String?
  mac         String?
  ssid        String?
  channel     Int?
  rssi        Int?
  message     String?
  payload     Json?
  triggeredAt DateTime  @default(now())
  createdAt   DateTime  @default(now())

  rule AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([triggeredAt])
}

model Webhook {
  id                String             @id @default(cuid())
  name              String
  url               String
  secret            String?
  verifyTls         Boolean            @default(true)
  clientCert        String?
  clientKey         String?
  caBundle          String?
  subscribedEvents  WebhookEventType[] @default([])
  enabled           Boolean            @default(true)
  ownerId           String?
  lastSuccessAt     DateTime?
  lastFailureAt     DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  owner      User?               @relation(fields: [ownerId], references: [id])
  rules      AlertRuleWebhook[]
  deliveries WebhookDelivery[]

  @@index([ownerId])
  @@index([enabled])
}

model AlertRuleWebhook {
  id        String   @id @default(cuid())
  ruleId    String
  webhookId String
  createdAt DateTime @default(now())

  rule    AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  webhook Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@unique([ruleId, webhookId])
  @@index([webhookId])
}

model WebhookDelivery {
  id              String   @id @default(cuid())
  webhookId       String
  ruleId          String?
  statusCode      Int?
  success         Boolean  @default(false)
  attempt         Int      @default(1)
  requestPayload  Json?
  responseBody    String?
  errorMessage    String?
  triggeredAt     DateTime @default(now())
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  webhook Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  rule    AlertRule? @relation(fields: [ruleId], references: [id])

  @@index([webhookId])
  @@index([ruleId])
  @@index([success])
  @@index([createdAt])
}

model CommandTemplate {
  id         String   @id @default(cuid())
  siteId     String?
  name       String
  template   String
  parameters Json?
  createdBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  site Site? @relation(fields: [siteId], references: [id])
}

model CommandLog {
  id                String        @id @default(cuid())
  siteId            String?
  originSiteId      String?
  userId            String?
  target            String
  name              String
  params            Json?
  status            CommandStatus @default(PENDING)
  startedAt         DateTime      @default(now())
  createdAt         DateTime      @default(now())
  finishedAt        DateTime?
  ackKind           String?
  ackStatus         String?
  ackNode           String?
  resultText        String?
  errorText         String?
  idempotencyKey    String?       @unique
  requestIp         String?
  userAgent         String?
  clientFingerprint String?

  site       Site? @relation(fields: [siteId], references: [id])
  originSite Site? @relation("CommandOriginSite", fields: [originSiteId], references: [id])
  user       User? @relation(fields: [userId], references: [id])

  @@index([siteId])
  @@index([originSiteId])
  @@index([status])
  @@index([createdAt])
  @@index([target])
}

model Geofence {
  id                 String     @id @default(cuid())
  siteId             String?
  originSiteId       String?
  name               String
  description        String?
  color              String     @default("#1d4ed8")
  polygon            Json
  alarmEnabled       Boolean    @default(true)
  alarmLevel         AlarmLevel @default(ALERT)
  alarmMessage       String     @default("{entity} entered geofence {geofence}")
  alarmTriggerOnExit Boolean    @default(false)
  appliesToAdsb      Boolean    @default(true)
  appliesToDrones    Boolean    @default(true)
  appliesToTargets   Boolean    @default(true)
  appliesToDevices   Boolean    @default(true)
  createdBy          String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  site Site? @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([originSiteId])
  @@index([updatedAt])
}

enum CommandStatus {
  PENDING
  SENT
  OK
  ERROR
}

model AuditLog {
  id        String   @id @default(cuid())
  siteId    String?
  userId    String?
  action    String
  entity    String?
  entityId  String?
  before    Json?
  after     Json?
  createdAt DateTime @default(now())

  site Site? @relation(fields: [siteId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([siteId, createdAt])
}

model OuiCache {
  oui       String   @id
  vendor    String
  updatedAt DateTime @updatedAt
}

model TriangulationResult {
  id        String   @id @default(cuid())
  nodeId    String
  targetRef String
  lines     String
  createdAt DateTime @default(now())

  node Node @relation(fields: [nodeId], references: [id])

  @@index([targetRef])
  @@index([nodeId, createdAt])
}

model AlarmConfig {
  id                Int      @id @default(1)
  audioPack         String   @default("default")
  volumeInfo        Int      @default(60)
  volumeNotice      Int      @default(70)
  volumeAlert       Int      @default(80)
  volumeCritical    Int      @default(90)
  volumeDroneGeofence   Int  @default(80)
  volumeDroneTelemetry  Int  @default(80)
  gapInfoMs         Int      @default(1000)
  gapNoticeMs       Int      @default(1500)
  gapAlertMs        Int      @default(2000)
  gapCriticalMs     Int      @default(0)
  dndStart          String?
  dndEnd            String?
  backgroundAllowed Boolean  @default(false)
  updatedAt         DateTime @updatedAt
}

model AlarmSound {
  level     String   @id
  filename  String
  updatedAt DateTime @updatedAt
}

model VisualConfig {
  id               Int      @id @default(1)
  pulseHzAlert     Float    @default(1.0)
  pulseHzCritical  Float    @default(2.0)
  blinkMs          Int      @default(400)
  strokeBasePx     Int      @default(2)
  strokeCriticalPx Int      @default(4)
  theme            String   @default("auto")
  updatedAt        DateTime @updatedAt
}

model CoverageConfig {
  id             Int      @id @default(1)
  defaultRadiusM Int      @default(50)
  dynamicEnabled Boolean  @default(false)
  dynamicModel   String?
  updatedAt      DateTime @updatedAt
}

model NodeCoverageOverride {
  nodeId       String   @id
  radiusMeters Int
  updatedAt    DateTime @updatedAt
}

model Site {
  id        String   @id
  name      String
  color     String   @default("#2E7D32")
  region    String?
  country   String?
  city      String?
  geojson   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mqtt              MqttConfig?
  nodes             Node[]
  targets           Target[]
  geofences         Geofence[]
  devices           InventoryDevice[]
  commandLogs       CommandLog[]
  originCommandLogs CommandLog[]      @relation("CommandOriginSite")
  audits            AuditLog[]
  templates         CommandTemplate[]
  userAccess        UserSiteAccess[]
  firewallLogs      FirewallLog[]
  drones            Drone[]
  originDrones      Drone[]          @relation("DroneOriginSite")
}

model SerialConfig {
  id                   String   @id @default("serial")
  devicePath           String?
  baud                 Int?
  dataBits             Int?
  parity               String?
  stopBits             Int?
  delimiter            String?
  reconnectBaseMs      Int?
  reconnectMaxMs       Int?
  reconnectJitter      Float?
  reconnectMaxAttempts Int?
  enabled              Boolean  @default(true)
  updatedAt            DateTime @updatedAt
}

model MqttConfig {
  id          Int      @id @default(autoincrement())
  brokerUrl   String
  clientId    String
  username    String?
  password    String?
  tlsEnabled  Boolean  @default(true)
  caPem       String?
  certPem     String?
  keyPem      String?
  qosEvents   Int      @default(1)
  qosCommands Int      @default(1)
  enabled     Boolean  @default(false)
  siteId      String
  updatedAt   DateTime @updatedAt

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId])
}

model UserPreference {
  userId          String   @id
  theme           String   @default("auto")
  density         String   @default("compact")
  themePreset     String   @default("classic")
  mapState        Json?
  tablePrefs      Json?
  terminalFilters Json?
  muteLevels      Json?
  language        String   @default("en")
  notifications   Json?
  timeFormat      String   @default("24h")
  alertColorIdle       String?
  alertColorInfo       String?
  alertColorNotice     String?
  alertColorAlert      String?
  alertColorCritical   String?
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

enum TargetStatus {
  ACTIVE
  TRIANGULATING
  RESOLVED
}

enum TakProtocol {
  UDP
  TCP
  HTTPS
}

model TakConfig {
  id                   Int         @id @default(1)
  enabled              Boolean     @default(false)
  protocol             TakProtocol @default(UDP)
  host                 String?
  port                 Int?
  tlsEnabled           Boolean     @default(false)
  cafile               String?
  certfile             String?
  keyfile              String?
  username             String?
  password             String?
  apiKey               String?
  streamNodes          Boolean     @default(true)
  streamTargets        Boolean     @default(true)
  streamCommandAcks    Boolean     @default(false)
  streamCommandResults Boolean     @default(false)
  streamAlertInfo      Boolean     @default(false)
  streamAlertNotice    Boolean     @default(true)
  streamAlertAlert     Boolean     @default(true)
  streamAlertCritical  Boolean     @default(true)
  lastConnected        DateTime?
  updatedAt            DateTime    @updatedAt
}

model FirewallConfig {
  id                 Int             @id @default(1)
  enabled            Boolean         @default(true)
  defaultPolicy      FirewallPolicy  @default(ALLOW)
  geoMode            FirewallGeoMode @default(DISABLED)
  allowedCountries   String[]        @default([])
  blockedCountries   String[]        @default([])
  ipAllowList        String[]        @default([])
  ipBlockList        String[]        @default([])
  failThreshold      Int             @default(5)
  failWindowSeconds  Int             @default(900)
  banDurationSeconds Int             @default(3600)
  updatedAt          DateTime        @updatedAt
}

model FirewallRule {
  id        String           @id @default(cuid())
  ip        String
  type      FirewallRuleType
  reason    String?
  expiresAt DateTime?
  createdBy String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([ip])
}

model FirewallLog {
  id        String             @id @default(cuid())
  ip        String
  country   String?
  path      String             @default("*")
  method    String             @default("UNKNOWN")
  outcome   FirewallLogOutcome
  ruleId    String?
  attempts  Int                @default(1)
  firstSeen DateTime           @default(now())
  lastSeen  DateTime           @default(now())
  blocked   Boolean            @default(false)
  reason    String?
  siteId    String?
  userAgent String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  site Site? @relation(fields: [siteId], references: [id])

  @@unique([ip, outcome, path])
  @@index([ip])
  @@index([outcome])
}

model FaaAircraft {
  id                String   @id @default(cuid())
  nNumber           String   @db.VarChar(10)
  serialNumber      String?  @db.VarChar(80)
  manufacturerModel String?  @db.VarChar(32)
  engineModel       String?  @db.VarChar(32)
  yearManufactured  Int?
  registrantType    Int?
  registrantName    String?
  street1           String?
  street2           String?
  city              String?
  state             String?  @db.VarChar(4)
  zip               String?  @db.VarChar(16)
  region            String?  @db.VarChar(4)
  county            String?
  country           String?
  lastActionDate    DateTime?
  certIssueDate     DateTime?
  certification     String?
  aircraftType      String?
  engineType        String?
  statusCode        String?  @db.VarChar(4)
  modeSCode         String?  @db.VarChar(16)
  modeSCodeHex      String?  @db.VarChar(16)
  fractionalOwner   Boolean?
  airworthinessDate DateTime?
  expirationDate    DateTime?
  uniqueId          String?  @db.VarChar(32)
  kitManufacturer   String?
  kitModel          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([nNumber])
  @@index([modeSCodeHex])
}

model FaaRegistrySync {
  id             Int      @id @default(1)
  datasetUrl     String?
  datasetVersion String?
  lastSyncedAt   DateTime?
  totalRecords   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model UserPermission {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  granted   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, feature])
}

enum SiteAccessLevel {
  VIEW
  MANAGE
}

model UserSiteAccess {
  id        String          @id @default(cuid())
  userId    String
  siteId    String
  level     SiteAccessLevel @default(VIEW)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id])
  site Site @relation(fields: [siteId], references: [id])

  @@unique([userId, siteId])
}

model UserInvitation {
  id          String    @id @default(cuid())
  email       String
  role        Role
  token       String    @unique
  expiresAt   DateTime
  siteIds     String[]
  permissions String[]  @default([])
  message     String?
  inviterId   String?
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())

  inviter User? @relation("UserInvitations", fields: [inviterId], references: [id])
}

model PasswordResetToken {
  id         String    @id @default(cuid())
  userId     String
  token      String    @unique
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  consumedAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
